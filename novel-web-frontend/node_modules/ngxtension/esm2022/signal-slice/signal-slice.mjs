import { DestroyRef, Injector, computed, effect, inject, signal, } from '@angular/core';
import { takeUntilDestroyed, toObservable } from '@angular/core/rxjs-interop';
import { connect } from 'ngxtension/connect';
import { createNotifier } from 'ngxtension/create-notifier';
import { Subject, isObservable, share, take } from 'rxjs';
export function signalSlice(config) {
    const destroyRef = inject(DestroyRef);
    const injector = inject(Injector);
    const { initialState, sources = [], lazySources = [], actionSources = {}, selectors = (() => ({})), effects = (() => ({})), } = config;
    const state = signal(initialState);
    const readonlyState = state.asReadonly();
    const state$ = toObservable(state);
    let lazySourcesLoaded = false;
    const subs = [];
    const slice = readonlyState;
    for (const [key, actionSource] of Object.entries(actionSources)) {
        if (isObservable(actionSource)) {
            addReducerProperties(readonlyState, state$, key, destroyRef, actionSource, subs);
        }
        else {
            const subject = new Subject();
            const observable = actionSource(readonlyState, subject);
            const sharedObservable = observable.pipe(share());
            connect(state, sharedObservable);
            addReducerProperties(readonlyState, state$, key, destroyRef, subject, subs, sharedObservable);
        }
    }
    for (const key in initialState) {
        const value = computed(() => readonlyState()[key]);
        Object.defineProperty(readonlyState, key, {
            value,
        });
        readonlyState[`${key}$`] = toObservable(value);
    }
    for (const [key, selector] of Object.entries(selectors(slice))) {
        const value = computed(selector);
        Object.defineProperty(readonlyState, key, {
            value,
        });
        readonlyState[`${key}$`] = toObservable(value);
    }
    for (const [key, namedEffect] of Object.entries(effects(slice))) {
        console.warn("The 'effects' configuration in signalSlice is deprecated. Please use standard signal effects outside of signalSlice instead.");
        Object.defineProperty(slice, key, {
            value: effect((onCleanup) => {
                const maybeCleanup = namedEffect();
                if (maybeCleanup) {
                    onCleanup(() => maybeCleanup());
                }
            }),
        });
    }
    connectSources(state, sources, readonlyState);
    destroyRef.onDestroy(() => {
        subs.forEach((sub) => sub.complete());
    });
    const connectLazySources = () => {
        if (!lazySourcesLoaded) {
            lazySourcesLoaded = true;
            connectSources(state, lazySources, readonlyState, injector, true);
        }
    };
    return new Proxy(slice, {
        get(target, property, receiver) {
            connectLazySources();
            return Reflect.get(target, property, receiver);
        },
        apply(target, thisArg, argumentsList) {
            connectLazySources();
            return Reflect.apply(target, thisArg, argumentsList);
        },
    });
}
function connectSources(state, sources, readonlyState, injector, useUntracked = false) {
    for (const source of sources) {
        if (isObservable(source)) {
            connect(state, source, injector, useUntracked);
        }
        else {
            connect(state, source(readonlyState), injector, useUntracked);
        }
    }
}
function addReducerProperties(readonlyState, state$, key, destroyRef, subject, subs, observableFromActionSource) {
    const version = createNotifier();
    Object.defineProperties(readonlyState, {
        [key]: {
            value: (nextValue) => {
                if (isObservable(nextValue)) {
                    return new Promise((res, rej) => {
                        nextValue.pipe(takeUntilDestroyed(destroyRef)).subscribe({
                            next: (value) => {
                                version.notify();
                                subject.next(value);
                            },
                            error: (err) => {
                                subject.error(err);
                                rej(err);
                            },
                            complete: () => {
                                version.notify();
                                subject.complete();
                                res(readonlyState());
                            },
                        });
                    });
                }
                if (observableFromActionSource) {
                    observableFromActionSource
                        .pipe(takeUntilDestroyed(destroyRef))
                        .subscribe();
                }
                return new Promise((res) => {
                    state$.pipe(take(1)).subscribe((val) => {
                        res(val);
                    });
                    version.notify();
                    subject.next(nextValue);
                });
            },
        },
        [`${key}$`]: {
            value: subject.asObservable(),
        },
        [`${key}Updated`]: {
            value: version.listen,
        },
    });
    subs.push(subject);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2lnbmFsLXNsaWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vbGlicy9uZ3h0ZW5zaW9uL3NpZ25hbC1zbGljZS9zcmMvc2lnbmFsLXNsaWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTixVQUFVLEVBQ1YsUUFBUSxFQUNSLFFBQVEsRUFDUixNQUFNLEVBQ04sTUFBTSxFQUNOLE1BQU0sR0FJTixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsa0JBQWtCLEVBQUUsWUFBWSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDOUUsT0FBTyxFQUFFLE9BQU8sRUFBdUIsTUFBTSxvQkFBb0IsQ0FBQztBQUNsRSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDNUQsT0FBTyxFQUFFLE9BQU8sRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBbUIsTUFBTSxNQUFNLENBQUM7QUE0SDNFLE1BQU0sVUFBVSxXQUFXLENBS3pCLE1BVUQ7SUFDQSxNQUFNLFVBQVUsR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDdEMsTUFBTSxRQUFRLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBRWxDLE1BQU0sRUFDTCxZQUFZLEVBQ1osT0FBTyxHQUFHLEVBQUUsRUFDWixXQUFXLEdBQUcsRUFBRSxFQUNoQixhQUFhLEdBQUcsRUFBRSxFQUNsQixTQUFTLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUd0QixFQUNELE9BQU8sR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBR3BCLEdBQ0QsR0FBRyxNQUFNLENBQUM7SUFFWCxNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDbkMsTUFBTSxhQUFhLEdBQUcsS0FBSyxDQUFDLFVBQVUsRUFBRSxDQUFDO0lBQ3pDLE1BQU0s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QUN4QixJQUFJLENBQUMsa0JBQWtCLENBQUMsVUFBVSxDQUFDLENBQUM7eUJBQ3BDLFNBQVMsRUFBRSxDQUFDO2dCQUNmLENBQUM7Z0JBRUQsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO29CQUMxQixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO3dCQUN0QyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQ1YsQ0FBQyxDQUFDLENBQUM7b0JBQ0gsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDO29CQUNqQixPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUN6QixDQUFDLENBQUMsQ0FBQztZQUNKLENBQUM7U0FDRDtRQUNELENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxFQUFFO1lBQ1osS0FBSyxFQUFFLE9BQU8sQ0FBQyxZQUFZLEVBQUU7U0FDN0I7UUFDRCxDQUFDLEdBQUcsR0FBRyxTQUFTLENBQUMsRUFBRTtZQUNsQixLQUFLLEVBQUUsT0FBTyxDQUFDLE1BQU07U0FDckI7S0FDRCxDQUFDLENBQUM7SUFDSCxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQ3BCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuXHREZXN0cm95UmVmLFxuXHRJbmplY3Rvcixcblx0Y29tcHV0ZWQsXG5cdGVmZmVjdCxcblx0aW5qZWN0LFxuXHRzaWduYWwsXG5cdHR5cGUgRWZmZWN0UmVmLFxuXHR0eXBlIFNpZ25hbCxcblx0dHlwZSBXcml0YWJsZVNpZ25hbCxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyB0YWtlVW50aWxEZXN0cm95ZWQsIHRvT2JzZXJ2YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUvcnhqcy1pbnRlcm9wJztcbmltcG9ydCB7IGNvbm5lY3QsIHR5cGUgUGFydGlhbE9yVmFsdWUgfSBmcm9tICduZ3h0ZW5zaW9uL2Nvbm5lY3QnO1xuaW1wb3J0IHsgY3JlYXRlTm90aWZpZXIgfSBmcm9tICduZ3h0ZW5zaW9uL2NyZWF0ZS1ub3RpZmllcic7XG5pbXBvcnQgeyBTdWJqZWN0LCBpc09ic2VydmFibGUsIHNoYXJlLCB0YWtlLCB0eXBlIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcblxudHlwZSBBY3Rpb25Tb3VyY2VGbjxUU2lnbmFsVmFsdWUsIFRQYXlsb2FkPiA9IChcblx0c3RhdGU6IFNpZ25hbDxUU2lnbmFsVmFsdWU+LFxuXHR2YWx1ZTogVFBheWxvYWQsXG4pID0+IE9ic2VydmFibGU8UGFydGlhbE9yVmFsdWU8VFNpZ25hbFZhbHVlPj47XG5cbnR5cGUgTm9PcHRpb25hbFByb3BlcnRpZXM8VD4gPSB7XG5cdFtQIGluIGtleW9mIFRdLT86IFRbUF07XG59O1xuXG50eXBlIE5hbWVkQWN0aW9uU291cmNlczxUU2lnbmFsVmFsdWU+ID0ge1xuXHRbYWN0aW9uTmFtZTogc3RyaW5nXTogU3ViamVjdDxhbnk+IHwgQWN0aW9uU291cmNlRm48VFNpZ25hbFZhbHVlLCBhbnk+O1xufTtcblxudHlwZSBOYW1lZFNlbGVjdG9ycyA9IHtcblx0W3NlbGVjdG9yTmFtZTogc3RyaW5nXTogKCkgPT4gYW55O1xufTtcblxudHlwZSBTZWxlY3RvcnM8VFNpZ25hbFZhbHVlPiA9IHtcblx0W0sgaW4ga2V5b2YgVFNpZ25hbFZhbHVlXTogU2lnbmFsPFRTaWduYWxWYWx1ZVtLXT47XG59O1xuXG50eXBlIEV4dHJhU2VsZWN0b3JzPFRTZWxlY3RvcnMgZXh0ZW5kcyBOYW1lZFNlbGVjdG9ycz4gPSB7XG5cdFtLIGluIGtleW9mIFRTZWxlY3RvcnNdOiBTaWduYWw8UmV0dXJuVHlwZTxUU2VsZWN0b3JzW0tdPj47XG59O1xuXG50eXBlIE5hbWVkRWZmZWN0cyA9IHtcblx0W3NlbGVjdG9yTmFtZTogc3RyaW5nXTogKCkgPT4gdm9pZCB8ICgoKSA9PiB2b2lkKTtcbn07XG5cbnR5cGUgRWZmZWN0czxURWZmZWN0cyBleHRlbmRzIE5hbWVkRWZmZWN0cz4gPSB7XG5cdFtLIGluIGtleW9mIFRFZmZlY3RzXTogRWZmZWN0UmVmO1xufTtcblxudHlwZSBBY3Rpb248VFNpZ25hbFZhbHVlLCBUVmFsdWU+ID0gVFZhbHVlIGV4dGVuZHMgW3ZvaWRdXG5cdD8gKCkgPT4gUHJvbWlzZTxUU2lnbmFsVmFsdWU+XG5cdDogW3Vua25vd25dIGV4dGVuZHMgVFZhbHVlXG5cdFx0PyAoKSA9PiBQcm9taXNlPFRTaWduYWxWYWx1ZT5cblx0XHQ6IChcblx0XHRcdFx0dmFsdWU6IFRWYWx1ZSBleHRlbmRzIFtpbmZlciBUSW5mZXJyZWRdXG5cdFx0XHRcdFx0PyBUSW5mZXJyZWQgfCBPYnNlcnZhYmxlPFRJbmZlcnJlZD5cblx0XHRcdFx0XHQ6IFRWYWx1ZSB8IE9ic2VydmFibGU8VFZhbHVlPixcblx0XHRcdCkgPT4gUHJvbWlzZTxUU2lnbmFsVmFsdWU+O1xuXG50eXBlIEFjdGlvbk1ldGhvZDxcblx0VFNpZ25hbFZhbHVlLFxuXHRUQWN0aW9uU291cmNlIGV4dGVuZHMgTmFtZWRBY3Rpb25Tb3VyY2VzPFRTaWduYWxWYWx1ZT5bc3RyaW5nXSxcbj4gPSBUQWN0aW9uU291cmNlIGV4dGVuZHMgKFxuXHRzdGF0ZTogU2lnbmFsPFRTaWduYWxWYWx1ZT4sXG5cdHZhbHVlOiBPYnNlcnZhYmxlPGluZmVyIFRPYnNlcnZhYmxlVmFsdWU+LFxuKSA9PiBhbnlcblx0PyBBY3Rpb248VFNpZ25hbFZhbHVlLCBbVE9ic2VydmFibGVWYWx1ZV0+XG5cdDogVEFjdGlvblNvdXJjZSBleHRlbmRzIFN1YmplY3Q8aW5mZXIgVFN1YmplY3RWYWx1ZT5cblx0XHQ/IEFjdGlvbjxUU2lnbmFsVmFsdWUsIFtUU3ViamVjdFZhbHVlXT5cblx0XHQ6IG5ldmVyO1xuXG50eXBlIEFjdGlvbk1ldGhvZHM8XG5cdFRTaWduYWxWYWx1ZSxcblx0VEFjdGlvblNvdXJjZXMgZXh0ZW5kcyBOYW1lZEFjdGlvblNvdXJjZXM8VFNpZ25hbFZhbHVlPixcbj4gPSB7XG5cdFtLIGluIGtleW9mIFRBY3Rpb25Tb3VyY2VzXTogQWN0aW9uTWV0aG9kPFRTaWduYWxWYWx1ZSwgVEFjdGlvblNvdXJjZXNbS10+O1xufTtcblxudHlwZSBBY3Rpb25TdHJlYW1zPFxuXHRUU2lnbmFsVmFsdWUsXG5cdFRBY3Rpb25Tb3VyY2VzIGV4dGVuZHMgTmFtZWRBY3Rpb25Tb3VyY2VzPFRTaWduYWxWYWx1ZT4sXG4+ID0ge1xuXHRbSyBpbiBrZXlvZiBUQWN0aW9uU291cmNlcyAmXG5cdFx0c3RyaW5nIGFzIGAke0t9JGBdOiBUQWN0aW9uU291cmNlc1tLXSBleHRlbmRzIEFjdGlvblNvdXJjZUZuPFxuXHRcdFRTaWduYWxWYWx1ZSxcblx0XHR1bmtub3duXG5cdD5cblx0XHQ/IE9ic2VydmFibGU8dm9pZD5cblx0XHQ6IFRBY3Rpb25Tb3VyY2VzW0tdIGV4dGVuZHMgQWN0aW9uU291cmNlRm48VFNpZ25hbFZhbHVlLCBpbmZlciBUVmFsdWU+XG5cdFx0XHQ/IFRWYWx1ZSBleHRlbmRzIE9ic2VydmFibGU8YW55PlxuXHRcdFx0XHQ/IFRWYWx1ZVxuXHRcdFx0XHQ6IE9ic2VydmFibGU8VFZhbHVlPlxuXHRcdFx0OiBuZXZlcjtcbn07XG5cbnR5cGUgSW5pdGlhbFN0YXRlU3RyZWFtczxUU2lnbmFsVmFsdWU+ID0ge1xuXHRbSyBpbiBrZXlvZiBUU2lnbmFsVmFsdWUgJiBzdHJpbmcgYXMgYCR7S30kYF06IE9ic2VydmFibGU8VFNpZ25hbFZhbHVlW0tdPjtcbn07XG5cbnR5cGUgQWN0aW9uVXBkYXRlczxcblx0VFNpZ25hbFZhbHVlLFxuXHRUQWN0aW9uU291cmNlcyBleHRlbmRzIE5hbWVkQWN0aW9uU291cmNlczxUU2lnbmFsVmFsdWU+LFxuPiA9IHtcblx0W0sgaW4ga2V5b2YgVEFjdGlvblNvdXJjZXMgJiBzdHJpbmcgYXMgYCR7S31VcGRhdGVkYF06IFNpZ25hbDxudW1iZXI+O1xufTtcblxuZXhwb3J0IHR5cGUgU291cmNlPFRTaWduYWxWYWx1ZT4gPSBPYnNlcnZhYmxlPFBhcnRpYWxPclZhbHVlPFRTaWduYWxWYWx1ZT4+O1xudHlwZSBTb3VyY2VDb25maWc8VFNpZ25hbFZhbHVlPiA9IEFycmF5PFxuXHR8IFNvdXJjZTxUU2lnbmFsVmFsdWU+XG5cdHwgKChcblx0XHRcdHN0YXRlOiBTaWduYWw8VFNpZ25hbFZhbHVlPiAmIEluaXRpYWxTdGF0ZVN0cmVhbXM8VFNpZ25hbFZhbHVlPixcblx0ICApID0+IFNvdXJjZTxUU2lnbmFsVmFsdWU+KVxuPjtcblxuZXhwb3J0IHR5cGUgU2lnbmFsU2xpY2U8XG5cdFRTaWduYWxWYWx1ZSBleHRlbmRzIE5vT3B0aW9uYWxQcm9wZXJ0aWVzPFRTaWduYWxWYWx1ZT4sXG5cdFRBY3Rpb25Tb3VyY2VzIGV4dGVuZHMgTmFtZWRBY3Rpb25Tb3VyY2VzPFRTaWduYWxWYWx1ZT4sXG5cdFRTZWxlY3RvcnMgZXh0ZW5kcyBOYW1lZFNlbGVjdG9ycyxcblx0VEVmZmVjdHMgZXh0ZW5kcyBOYW1lZEVmZmVjdHMsXG4+ID0gU2lnbmFsPFRTaWduYWxWYWx1ZT4gJlxuXHRTZWxlY3RvcnM8VFNpZ25hbFZhbHVlPiAmXG5cdEV4dHJhU2VsZWN0b3JzPFRTZWxlY3RvcnM+ICZcblx0RWZmZWN0czxURWZmZWN0cz4gJlxuXHRBY3Rpb25NZXRob2RzPFRTaWduYWxWYWx1ZSwgVEFjdGlvblNvdXJjZXM+ICZcblx0QWN0aW9uU3RyZWFtczxUU2lnbmFsVmFsdWUsIFRBY3Rpb25Tb3VyY2VzPiAmXG5cdEFjdGlvblVwZGF0ZXM8VFNpZ25hbFZhbHVlLCBUQWN0aW9uU291cmNlcz47XG5cbnR5cGUgU2VsZWN0b3JzU3RhdGU8VFNpZ25hbFZhbHVlIGV4dGVuZHMgTm9PcHRpb25hbFByb3BlcnRpZXM8VFNpZ25hbFZhbHVlPj4gPVxuXHRTaWduYWw8VFNpZ25hbFZhbHVlPiAmIFNlbGVjdG9yczxUU2lnbmFsVmFsdWU+O1xuXG50eXBlIEVmZmVjdHNTdGF0ZTxcblx0VFNpZ25hbFZhbHVlIGV4dGVuZHMgTm9PcHRpb25hbFByb3BlcnRpZXM8VFNpZ25hbFZhbHVlPixcblx0VEFjdGlvblNvdXJjZXMgZXh0ZW5kcyBOYW1lZEFjdGlvblNvdXJjZXM8VFNpZ25hbFZhbHVlPixcblx0VFNlbGVjdG9ycyBleHRlbmRzIE5hbWVkU2VsZWN0b3JzLFxuPiA9IFNlbGVjdG9yc1N0YXRlPFRTaWduYWxWYWx1ZT4gJlxuXHRFeHRyYVNlbGVjdG9yczxUU2VsZWN0b3JzPiAmXG5cdEFjdGlvbk1ldGhvZHM8VFNpZ25hbFZhbHVlLCBUQWN0aW9uU291cmNlcz47XG5cbmV4cG9ydCBmdW5jdGlvbiBzaWduYWxTbGljZTxcblx0VFNpZ25hbFZhbHVlIGV4dGVuZHMgTm9PcHRpb25hbFByb3BlcnRpZXM8VFNpZ25hbFZhbHVlPixcblx0VEFjdGlvblNvdXJjZXMgZXh0ZW5kcyBOYW1lZEFjdGlvblNvdXJjZXM8VFNpZ25hbFZhbHVlPixcblx0VFNlbGVjdG9ycyBleHRlbmRzIE5hbWVkU2VsZWN0b3JzLFxuXHRURWZmZWN0cyBleHRlbmRzIE5hbWVkRWZmZWN0cyxcbj4oY29uZmlnOiB7XG5cdGluaXRpYWxTdGF0ZTogVFNpZ25hbFZhbHVlO1xuXHRzb3VyY2VzPzogU291cmNlQ29uZmlnPFRTaWduYWxWYWx1ZT47XG5cdGxhenlTb3VyY2VzPzogU291cmNlQ29uZmlnPFRTaWduYWxWYWx1ZT47XG5cdGFjdGlvblNvdXJjZXM/OiBUQWN0aW9uU291cmNlcztcblx0c2VsZWN0b3JzPzogKHN0YXRlOiBTZWxlY3RvcnNTdGF0ZTxUU2lnbmFsVmFsdWU+KSA9PiBUU2VsZWN0b3JzO1xuXHQvKiogQGRlcHJlY2F0ZWQgKi9cblx0ZWZmZWN0cz86IChcblx0XHRzdGF0ZTogRWZmZWN0c1N0YXRlPFRTaWduYWxWYWx1ZSwgVEFjdGlvblNvdXJjZXMsIFRTZWxlY3RvcnM+LFxuXHQpID0+IFRFZmZlY3RzO1xufSk6IFNpZ25hbFNsaWNlPFRTaWduYWxWYWx1ZSwgVEFjdGlvblNvdXJjZXMsIFRTZWxlY3RvcnMsIFRFZmZlY3RzPiB7XG5cdGNvbnN0IGRlc3Ryb3lSZWYgPSBpbmplY3QoRGVzdHJveVJlZik7XG5cdGNvbnN0IGluamVjdG9yID0gaW5qZWN0KEluamVjdG9yKTtcblxuXHRjb25zdCB7XG5cdFx0aW5pdGlhbFN0YXRlLFxuXHRcdHNvdXJjZXMgPSBbXSxcblx0XHRsYXp5U291cmNlcyA9IFtdLFxuXHRcdGFjdGlvblNvdXJjZXMgPSB7fSxcblx0XHRzZWxlY3RvcnMgPSAoKCkgPT4gKHt9KSkgYXMgdW5rbm93biBhcyBFeGNsdWRlPFxuXHRcdFx0KHR5cGVvZiBjb25maWcpWydzZWxlY3RvcnMnXSxcblx0XHRcdHVuZGVmaW5lZFxuXHRcdD4sXG5cdFx0ZWZmZWN0cyA9ICgoKSA9PiAoe30pKSBhcyB1bmtub3duIGFzIEV4Y2x1ZGU8XG5cdFx0XHQodHlwZW9mIGNvbmZpZylbJ2VmZmVjdHMnXSxcblx0XHRcdHVuZGVmaW5lZFxuXHRcdD4sXG5cdH0gPSBjb25maWc7XG5cblx0Y29uc3Qgc3RhdGUgPSBzaWduYWwoaW5pdGlhbFN0YXRlKTtcblx0Y29uc3QgcmVhZG9ubHlTdGF0ZSA9IHN0YXRlLmFzUmVhZG9ubHkoKTtcblx0Y29uc3Qgc3RhdGUkID0gdG9PYnNlcnZhYmxlKHN0YXRlKTtcblx0bGV0IGxhenlTb3VyY2VzTG9hZGVkID0gZmFsc2U7XG5cblx0Y29uc3Qgc3ViczogU3ViamVjdDxhbnk+W10gPSBbXTtcblxuXHRjb25zdCBzbGljZSA9IHJlYWRvbmx5U3RhdGUgYXMgU2lnbmFsU2xpY2U8XG5cdFx0VFNpZ25hbFZhbHVlLFxuXHRcdFRBY3Rpb25Tb3VyY2VzLFxuXHRcdFRTZWxlY3RvcnMsXG5cdFx0VEVmZmVjdHNcblx0PjtcblxuXHRmb3IgKGNvbnN0IFtrZXksIGFjdGlvblNvdXJjZV0gb2YgT2JqZWN0LmVudHJpZXMoXG5cdFx0YWN0aW9uU291cmNlcyBhcyBUQWN0aW9uU291cmNlcyxcblx0KSkge1xuXHRcdGlmIChpc09ic2VydmFibGUoYWN0aW9uU291cmNlKSkge1xuXHRcdFx0YWRkUmVkdWNlclByb3BlcnRpZXMoXG5cdFx0XHRcdHJlYWRvbmx5U3RhdGUsXG5cdFx0XHRcdHN0YXRlJCxcblx0XHRcdFx0a2V5LFxuXHRcdFx0XHRkZXN0cm95UmVmLFxuXHRcdFx0XHRhY3Rpb25Tb3VyY2UsXG5cdFx0XHRcdHN1YnMsXG5cdFx0XHQpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRjb25zdCBzdWJqZWN0ID0gbmV3IFN1YmplY3QoKTtcblx0XHRcdGNvbnN0IG9ic2VydmFibGUgPSBhY3Rpb25Tb3VyY2UocmVhZG9ubHlTdGF0ZSwgc3ViamVjdCk7XG5cdFx0XHRjb25zdCBzaGFyZWRPYnNlcnZhYmxlID0gb2JzZXJ2YWJsZS5waXBlKHNoYXJlKCkpO1xuXHRcdFx0Y29ubmVjdChzdGF0ZSwgc2hhcmVkT2JzZXJ2YWJsZSk7XG5cdFx0XHRhZGRSZWR1Y2VyUHJvcGVydGllcyhcblx0XHRcdFx0cmVhZG9ubHlTdGF0ZSxcblx0XHRcdFx0c3RhdGUkLFxuXHRcdFx0XHRrZXksXG5cdFx0XHRcdGRlc3Ryb3lSZWYsXG5cdFx0XHRcdHN1YmplY3QsXG5cdFx0XHRcdHN1YnMsXG5cdFx0XHRcdHNoYXJlZE9ic2VydmFibGUsXG5cdFx0XHQpO1xuXHRcdH1cblx0fVxuXG5cdGZvciAoY29uc3Qga2V5IGluIGluaXRpYWxTdGF0ZSkge1xuXHRcdGNvbnN0IHZhbHVlID0gY29tcHV0ZWQoKCkgPT4gcmVhZG9ubHlTdGF0ZSgpW2tleV0pO1xuXHRcdE9iamVjdC5kZWZpbmVQcm9wZXJ0eShyZWFkb25seVN0YXRlLCBrZXksIHtcblx0XHRcdHZhbHVlLFxuXHRcdH0pO1xuXHRcdChyZWFkb25seVN0YXRlIGFzIGFueSlbYCR7a2V5fSRgXSA9IHRvT2JzZXJ2YWJsZSh2YWx1ZSk7XG5cdH1cblxuXHRmb3IgKGNvbnN0IFtrZXksIHNlbGVjdG9yXSBvZiBPYmplY3QuZW50cmllcyhzZWxlY3RvcnMoc2xpY2UpKSkge1xuXHRcdGNvbnN0IHZhbHVlID0gY29tcHV0ZWQoc2VsZWN0b3IpO1xuXG5cdFx0T2JqZWN0LmRlZmluZVByb3BlcnR5KHJlYWRvbmx5U3RhdGUsIGtleSwge1xuXHRcdFx0dmFsdWUsXG5cdFx0fSk7XG5cdFx0KHJlYWRvbmx5U3RhdGUgYXMgYW55KVtgJHtrZXl9JGBdID0gdG9PYnNlcnZhYmxlKHZhbHVlKTtcblx0fVxuXG5cdGZvciAoY29uc3QgW2tleSwgbmFtZWRFZmZlY3RdIG9mIE9iamVjdC5lbnRyaWVzKGVmZmVjdHMoc2xpY2UpKSkge1xuXHRcdGNvbnNvbGUud2Fybihcblx0XHRcdFwiVGhlICdlZmZlY3RzJyBjb25maWd1cmF0aW9uIGluIHNpZ25hbFNsaWNlIGlzIGRlcHJlY2F0ZWQuIFBsZWFzZSB1c2Ugc3RhbmRhcmQgc2lnbmFsIGVmZmVjdHMgb3V0c2lkZSBvZiBzaWduYWxTbGljZSBpbnN0ZWFkLlwiLFxuXHRcdCk7XG5cdFx0T2JqZWN0LmRlZmluZVByb3BlcnR5KHNsaWNlLCBrZXksIHtcblx0XHRcdHZhbHVlOiBlZmZlY3QoKG9uQ2xlYW51cCkgPT4ge1xuXHRcdFx0XHRjb25zdCBtYXliZUNsZWFudXAgPSBuYW1lZEVmZmVjdCgpO1xuXHRcdFx0XHRpZiAobWF5YmVDbGVhbnVwKSB7XG5cdFx0XHRcdFx0b25DbGVhbnVwKCgpID0+IG1heWJlQ2xlYW51cCgpKTtcblx0XHRcdFx0fVxuXHRcdFx0fSksXG5cdFx0fSk7XG5cdH1cblxuXHRjb25uZWN0U291cmNlcyhzdGF0ZSwgc291cmNlcywgcmVhZG9ubHlTdGF0ZSk7XG5cblx0ZGVzdHJveVJlZi5vbkRlc3Ryb3koKCkgPT4ge1xuXHRcdHN1YnMuZm9yRWFjaCgoc3ViKSA9PiBzdWIuY29tcGxldGUoKSk7XG5cdH0pO1xuXG5cdGNvbnN0IGNvbm5lY3RMYXp5U291cmNlcyA9ICgpID0+IHtcblx0XHRpZiAoIWxhenlTb3VyY2VzTG9hZGVkKSB7XG5cdFx0XHRsYXp5U291cmNlc0xvYWRlZCA9IHRydWU7XG5cdFx0XHRjb25uZWN0U291cmNlcyhzdGF0ZSwgbGF6eVNvdXJjZXMsIHJlYWRvbmx5U3RhdGUsIGluamVjdG9yLCB0cnVlKTtcblx0XHR9XG5cdH07XG5cblx0cmV0dXJuIG5ldyBQcm94eShzbGljZSwge1xuXHRcdGdldCh0YXJnZXQsIHByb3BlcnR5LCByZWNlaXZlcikge1xuXHRcdFx0Y29ubmVjdExhenlTb3VyY2VzKCk7XG5cdFx0XHRyZXR1cm4gUmVmbGVjdC5nZXQodGFyZ2V0LCBwcm9wZXJ0eSwgcmVjZWl2ZXIpO1xuXHRcdH0sXG5cdFx0YXBwbHkodGFyZ2V0LCB0aGlzQXJnLCBhcmd1bWVudHNMaXN0KSB7XG5cdFx0XHRjb25uZWN0TGF6eVNvdXJjZXMoKTtcblx0XHRcdHJldHVybiBSZWZsZWN0LmFwcGx5KHRhcmdldCwgdGhpc0FyZywgYXJndW1lbnRzTGlzdCk7XG5cdFx0fSxcblx0fSk7XG59XG5cbmZ1bmN0aW9uIGNvbm5lY3RTb3VyY2VzPFRTaWduYWxWYWx1ZT4oXG5cdHN0YXRlOiBXcml0YWJsZVNpZ25hbDxUU2lnbmFsVmFsdWU+LFxuXHRzb3VyY2VzOiBTb3VyY2VDb25maWc8VFNpZ25hbFZhbHVlPixcblx0cmVhZG9ubHlTdGF0ZTogU2lnbmFsPFRTaWduYWxWYWx1ZT4sXG5cdGluamVjdG9yPzogSW5qZWN0b3IsXG5cdHVzZVVudHJhY2tlZCA9IGZhbHNlLFxuKSB7XG5cdGZvciAoY29uc3Qgc291cmNlIG9mIHNvdXJjZXMpIHtcblx0XHRpZiAoaXNPYnNlcnZhYmxlKHNvdXJjZSkpIHtcblx0XHRcdGNvbm5lY3Qoc3RhdGUsIHNvdXJjZSwgaW5qZWN0b3IsIHVzZVVudHJhY2tlZCk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGNvbm5lY3Qoc3RhdGUsIHNvdXJjZShyZWFkb25seVN0YXRlIGFzIGFueSksIGluamVjdG9yLCB1c2VVbnRyYWNrZWQpO1xuXHRcdH1cblx0fVxufVxuXG5mdW5jdGlvbiBhZGRSZWR1Y2VyUHJvcGVydGllcyhcblx0cmVhZG9ubHlTdGF0ZTogU2lnbmFsPHVua25vd24+LFxuXHRzdGF0ZSQ6IE9ic2VydmFibGU8dW5rbm93bj4sXG5cdGtleTogc3RyaW5nLFxuXHRkZXN0cm95UmVmOiBEZXN0cm95UmVmLFxuXHRzdWJqZWN0OiBTdWJqZWN0PHVua25vd24+LFxuXHRzdWJzOiBTdWJqZWN0PHVua25vd24+W10sXG5cdG9ic2VydmFibGVGcm9tQWN0aW9uU291cmNlPzogT2JzZXJ2YWJsZTxhbnk+LFxuKSB7XG5cdGNvbnN0IHZlcnNpb24gPSBjcmVhdGVOb3RpZmllcigpO1xuXHRPYmplY3QuZGVmaW5lUHJvcGVydGllcyhyZWFkb25seVN0YXRlLCB7XG5cdFx0W2tleV06IHtcblx0XHRcdHZhbHVlOiAobmV4dFZhbHVlOiB1bmtub3duKSA9PiB7XG5cdFx0XHRcdGlmIChpc09ic2VydmFibGUobmV4dFZhbHVlKSkge1xuXHRcdFx0XHRcdHJldHVybiBuZXcgUHJvbWlzZSgocmVzLCByZWopID0+IHtcblx0XHRcdFx0XHRcdG5leHRWYWx1ZS5waXBlKHRha2VVbnRpbERlc3Ryb3llZChkZXN0cm95UmVmKSkuc3Vic2NyaWJlKHtcblx0XHRcdFx0XHRcdFx0bmV4dDogKHZhbHVlKSA9PiB7XG5cdFx0XHRcdFx0XHRcdFx0dmVyc2lvbi5ub3RpZnkoKTtcblx0XHRcdFx0XHRcdFx0XHRzdWJqZWN0Lm5leHQodmFsdWUpO1xuXHRcdFx0XHRcdFx0XHR9LFxuXHRcdFx0XHRcdFx0XHRlcnJvcjogKGVycikgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdHN1YmplY3QuZXJyb3IoZXJyKTtcblx0XHRcdFx0XHRcdFx0XHRyZWooZXJyKTtcblx0XHRcdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRcdFx0Y29tcGxldGU6ICgpID0+IHtcblx0XHRcdFx0XHRcdFx0XHR2ZXJzaW9uLm5vdGlmeSgpO1xuXHRcdFx0XHRcdFx0XHRcdHN1YmplY3QuY29tcGxldGUoKTtcblx0XHRcdFx0XHRcdFx0XHRyZXMocmVhZG9ubHlTdGF0ZSgpKTtcblx0XHRcdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0aWYgKG9ic2VydmFibGVGcm9tQWN0aW9uU291cmNlKSB7XG5cdFx0XHRcdFx0b2JzZXJ2YWJsZUZyb21BY3Rpb25Tb3VyY2Vcblx0XHRcdFx0XHRcdC5waXBlKHRha2VVbnRpbERlc3Ryb3llZChkZXN0cm95UmVmKSlcblx0XHRcdFx0XHRcdC5zdWJzY3JpYmUoKTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdHJldHVybiBuZXcgUHJvbWlzZSgocmVzKSA9PiB7XG5cdFx0XHRcdFx0c3RhdGUkLnBpcGUodGFrZSgxKSkuc3Vic2NyaWJlKCh2YWwpID0+IHtcblx0XHRcdFx0XHRcdHJlcyh2YWwpO1xuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdHZlcnNpb24ubm90aWZ5KCk7XG5cdFx0XHRcdFx0c3ViamVjdC5uZXh0KG5leHRWYWx1ZSk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0fSxcblx0XHR9LFxuXHRcdFtgJHtrZXl9JGBdOiB7XG5cdFx0XHR2YWx1ZTogc3ViamVjdC5hc09ic2VydmFibGUoKSxcblx0XHR9LFxuXHRcdFtgJHtrZXl9VXBkYXRlZGBdOiB7XG5cdFx0XHR2YWx1ZTogdmVyc2lvbi5saXN0ZW4sXG5cdFx0fSxcblx0fSk7XG5cdHN1YnMucHVzaChzdWJqZWN0KTtcbn1cbiJdfQ==